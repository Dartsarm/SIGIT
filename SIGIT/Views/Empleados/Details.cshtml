@model SIGIT.Models.Empleado

@{
    Layout = null;

    //PREPARAMOS LAS VARIABLES PARA EL CORREO

    var nombreCompleto = string.Join(" ", new[] { Model.Nombre, Model.SegundoNombre, Model.Apellido, Model.SegundoApellido }
        .Where(s => !string.IsNullOrWhiteSpace(s)));

    var bodyBuilder = new System.Text.StringBuilder();
    bodyBuilder.AppendLine($"Cordial saludo, {nombreCompleto}");
    bodyBuilder.AppendLine();
    bodyBuilder.AppendLine("Remito los datos de conexión para las aplicaciones de Autofinanciera a las cuales tiene acceso.");
    bodyBuilder.AppendLine();
    bodyBuilder.AppendLine("URL SIICON: http://gestion.siicon.com.co");
    bodyBuilder.AppendLine("URL Qurii: http://qurii.co");
    bodyBuilder.AppendLine("URL HelpDesk: http://helpdesk.serven.com.co:8080/");
    bodyBuilder.AppendLine("URL Tableros: https://sites.google.com/autofinanciera.com.co/repositoriotableros/inicio");
    bodyBuilder.AppendLine();
    bodyBuilder.AppendLine("Se otorgará solamente acceso a los tableros a las cuentas corporativas.");
    bodyBuilder.AppendLine("Tenga presente que los usuarios y contraseñas son personales e intransferibles, abstenerse de compartir esta información ya que esto va en contra de las normas de seguridad de la información.");
    bodyBuilder.AppendLine();
    bodyBuilder.AppendLine("DATOS DEL USUARIO PARA NOTIFICACIONES");

    bodyBuilder.AppendLine($"Correo de notificaciones: {Model.CorreoPersonal}");
    bodyBuilder.AppendLine($"Área: {Model.Area?.NombreArea}");
    bodyBuilder.AppendLine($"Cargo: {Model.Cargo?.NombreCargo}");
    bodyBuilder.AppendLine($"Ciudad: {Model.Ciudad?.NombreCiudad}");
    bodyBuilder.AppendLine($"Compañía: {Model.Compania?.NombreCompania}");
    bodyBuilder.AppendLine($"Estatus: {Model.Estatus?.NombreEstatus}");
    bodyBuilder.AppendLine();
    bodyBuilder.AppendLine("CUENTAS ASIGNADAS:");

    if (Model.CuentasEmpleados != null) // Añadido check de nulidad
    {
        foreach (var cuenta in Model.CuentasEmpleados)
        {
            bodyBuilder.AppendLine($"Aplicación: {cuenta.Aplicacion?.NombreAplicacion}");
            bodyBuilder.AppendLine($"Usuario: {cuenta.Usuario}");
            bodyBuilder.AppendLine($"Contraseña: {cuenta.Contrasena}");
            bodyBuilder.AppendLine();
        }
    }
    var emailBody = bodyBuilder.ToString();

    var correoDestino = Model.CorreoPersonal;
    var asunto = "Credenciales acceso aplicaciones Autofinanciera y Fonbienes";
    var mailtoHref = $"mailto:{correoDestino}?subject={System.Net.WebUtility.UrlEncode(asunto)}";
}

<div class="modal-body">

    @Html.AntiForgeryToken()

    <div>
        <div class="row g-3">
            <dl class="row">
                <div class="col-md-12">
                    <div class="row">
                        <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Cedula)</dt>
                        <dd class="col-sm-9 d-inline-flex p-2">@Html.DisplayFor(model => model.Cedula)</dd>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="row">
                        <dt class="col-sm-3">Nombre Completo</dt>
                        <dd class="col-sm-9 d-inline-flex p-2">
                            @string.Join(" ", new[] { Model.Nombre, Model.SegundoNombre, Model.Apellido, Model.SegundoApellido }.Where(s => !string.IsNullOrWhiteSpace(s)))
                        </dd>
                    </div>
                </div>
                <hr />
                <div class="col-md-4">
                    <dt class="col-sm-4">@Html.DisplayNameFor(model => model.Celular)</dt>
                    <dd class="col-sm-12 border rounded-2 d-inline-flex p-2">@Html.DisplayFor(model => model.Celular)</dd>
                </div>
                <div class="col-md-8">
                    <dt class="col-sm-4">@Html.DisplayNameFor(model => model.CorreoPersonal)</dt>
                    <dd class="col-sm-12 border rounded-2 d-inline-flex p-2">@Html.DisplayFor(model => model.CorreoPersonal)</dd>
                </div>
                <hr />
                <div class="col-md-4">
                    <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Area)</dt>
                    <dd class="col-sm-12 border rounded-2 d-inline-flex p-2">@Html.DisplayFor(model => model.Area.NombreArea)</dd>
                </div>
                <div class="col-md-4">
                    <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Cargo)</dt>
                    <dd class="col-sm-12 border rounded-2 d-inline-flex p-2">@Html.DisplayFor(model => model.Cargo.NombreCargo)</dd>
                </div>
                <div class="col-md-4">
                    <dt class="col-sm-2">@Html.DisplayNameFor(model => model.Ciudad)</dt>
                    <dd class="col-sm-12 border rounded-2 d-inline-flex p-2">@Html.DisplayFor(model => model.Ciudad.NombreCiudad)</dd>
                </div>

                <div class="col-md-12">
                    <div class="row">
                        <dt class="col-sm-2">@Html.DisplayNameFor(model => model.Compania)</dt>
                        <dd class="col-sm-8 border rounded-2 d-inline-flex p-2">@Html.DisplayFor(model => model.Compania.NombreCompania)</dd>
                    </div>
                </div>
                <hr />
                <div class="col-md-4">
                    <dt class="col-sm-8">@Html.DisplayNameFor(model => model.FechaIngreso)</dt>
                    <dd class="col-sm-12 border rounded-2 d-inline-flex p-2">@Html.DisplayFor(model => model.FechaIngreso)</dd>
                </div>
                <div class="col-md-4">
                    <dt class="col-sm-8">@Html.DisplayNameFor(model => model.FechaRetiro)</dt>
                    <dd class="col-sm-12 border rounded-2 d-inline-flex p-2">@Html.DisplayFor(model => model.FechaRetiro)</dd>
                </div>
                <div class="col-md-4">
                    <dt class="col-sm-8">@Html.DisplayNameFor(model => model.FechaRegistro)</dt>
                    <dd class="col-sm-12 border rounded-2 d-inline-flex p-2">@Html.DisplayFor(model => model.FechaRegistro)</dd>
                </div>

                <div class="row col-md-12">
                    
                        <dt class="col-sm-2">@Html.DisplayNameFor(model => model.Estatus)</dt>
                        <dd class="col-sm-10 border rounded-2 d-inline-flex p-2">@Html.DisplayFor(model => model.Estatus.NombreEstatus)</dd>
                    
                </div>
            </dl>
        </div>
    </div>
    <hr />

    <h3>Cuentas asignadas</h3>
    @if (Model.CuentasEmpleados.Any())
    {
        <table class="table table-striped table-sm" style="font-size: 0.9em;">
            <thead>
                <tr>
                    <th>Aplicación</th>
                    <th>Usuario</th>
                    <th>Contraseña</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var cuenta in Model.CuentasEmpleados)
                {
                    <tr>
                        <td>@Html.DisplayFor(modelItem => cuenta.Aplicacion.NombreAplicacion)</td>
                        <td>@Html.DisplayFor(modelItem => cuenta.Usuario)</td>
                        <td>@Html.DisplayFor(modelItem => cuenta.Contrasena)</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p class="text-muted">Este empleado no tiene cuentas asignadas.</p>
    }

    <textarea id="emailNotificationBody" style="position: absolute; left: -9999px; opacity: 0;" readonly>@emailBody</textarea>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"><i class="bi bi-door-open-fill"></i>Cerrar</button>
    <button type="button" id="copyEmailButton" class="btn btn-primary"><i class="bi bi-clipboard-check"></i> Copiar Notificación</button>
    <button type="button" id="sendEmailButton" class="btn btn-success" data-id="@Model.EmpleadoId"><i class="bi bi-send-plus-fill"></i> Enviar por Correo</button>
</div>


<script>
    $(document).ready(function() {

        // Script para "Copiar"
        $("#copyEmailButton").on("click", function() {
            var copyText = document.getElementById("emailNotificationBody");
            copyText.select();
            document.execCommand("copy");
            var originalText = $(this).text();
            $(this).text("¡Copiado!").addClass("btn-success").removeClass("btn-primary");
            setTimeout(() => {
                 $(this).text(originalText).addClass("btn-primary").removeClass("btn-success");
            }, 2000);
        });

        // SCRIPT DE ENVÍO DE CORREO
        $("#sendEmailButton").on("click", function() {
            var button = $(this);
            var empleadoId = button.data("id");

            // Buscamos el token por su NOMBRE, que es como lo genera el helper
            var token = $('input[name="__RequestVerificationToken"]').val();

            button.prop("disabled", true).text("Enviando...");

            $.ajax({
                url: '@Url.Action("EnviarNotificacion", "Empleados")/' + empleadoId,
                type: 'POST',
                headers: {
                    // Enviamos el token que acabamos de leer
                    'RequestVerificationToken': token
                },
                success: function(response) {
                    if (response.success) {
                        button.text("¡Enviado!").addClass("btn-primary").removeClass("btn-success");
                        setTimeout(() => {
                             button.prop("disabled", false).text("Enviar por Correo").addClass("btn-success").removeClass("btn-primary");
                        }, 2000);
                    } else {
                        alert(response.message);
                        button.prop("disabled", false).text("Enviar por Correo");
                    }
                },
                error: function(xhr, status, error) {
                    alert("Error de red al enviar el correo: " + xhr.statusText);
                    button.prop("disabled", false).text("Enviar por Correo");
                }
            });
        });
    });
</script>